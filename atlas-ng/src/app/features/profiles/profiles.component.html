<div class="profiles-container">
  <div class="page-header">
    <div class="page-header__title">
      <i class="fas fa-user"></i>
      <h1>Profiles</h1>
    </div>
    <div class="page-header__subtitle">
      View individual patient records and clinical timelines
    </div>
  </div>

  <!-- Summary Stats -->
  <div class="stats-row">
    <mat-card class="stat-card">
      <div class="stat-icon total">
        <i class="fas fa-users"></i>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ profiles().length }}</span>
        <span class="stat-label">Total Profiles</span>
      </div>
    </mat-card>

    <mat-card class="stat-card">
      <div class="stat-icon male">
        <i class="fas fa-mars"></i>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ getMaleCount() }}</span>
        <span class="stat-label">Male</span>
      </div>
    </mat-card>

    <mat-card class="stat-card">
      <div class="stat-icon female">
        <i class="fas fa-venus"></i>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ getFemaleCount() }}</span>
        <span class="stat-label">Female</span>
      </div>
    </mat-card>

    <mat-card class="stat-card">
      <div class="stat-icon records">
        <i class="fas fa-database"></i>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ getAverageRecords() }}</span>
        <span class="stat-label">Avg Records</span>
      </div>
    </mat-card>
  </div>

  <!-- Filters -->
  <mat-card class="filter-card">
    <mat-card-content>
      <div class="filter-row">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Search profiles</mat-label>
          <input
            matInput
            [(ngModel)]="searchFilter"
            (ngModelChange)="applyFilters()"
            placeholder="Search by Person ID or cohort..."
          />
          <mat-icon matPrefix>search</mat-icon>
          @if (searchFilter) {
            <button mat-icon-button matSuffix (click)="searchFilter = ''; applyFilters()">
              <mat-icon>close</mat-icon>
            </button>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="source-filter">
          <mat-label>Data Source</mat-label>
          <mat-select [(ngModel)]="sourceFilter" (ngModelChange)="applyFilters()">
            @for (option of sourceOptions; track option.value) {
              <mat-option [value]="option.value">{{ option.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="gender-filter">
          <mat-label>Gender</mat-label>
          <mat-select [(ngModel)]="genderFilter" (ngModelChange)="applyFilters()">
            @for (option of genderOptions; track option.value) {
              <mat-option [value]="option.value">{{ option.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Results -->
  @if (loading()) {
    <div class="loading-container">
      <mat-spinner diameter="48"></mat-spinner>
      <p>Loading profiles...</p>
    </div>
  } @else if (filteredProfiles().length > 0) {
    <mat-card class="results-card">
      <mat-card-content>
        <table
          mat-table
          [dataSource]="getPaginatedProfiles()"
          matSort
          (matSortChange)="onSort($event)"
          class="profiles-table"
        >
          <!-- Person ID -->
          <ng-container matColumnDef="personId">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Person ID</th>
            <td mat-cell *matCellDef="let p">
              <span class="person-id">{{ p.personId }}</span>
            </td>
          </ng-container>

          <!-- Demographics -->
          <ng-container matColumnDef="demographics">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Demographics</th>
            <td mat-cell *matCellDef="let p">
              <div class="demographics-cell">
                <div class="gender-age">
                  <i [class]="p.gender === 'Male' ? 'fas fa-mars' : 'fas fa-venus'"
                     [ngClass]="p.gender === 'Male' ? 'male' : 'female'"></i>
                  <span>{{ p.gender }}, {{ calculateAge(p.birthYear, p.deathYear) }} yrs</span>
                </div>
                <div class="birth-year">
                  Born {{ p.birthYear }}
                  @if (p.deathYear) {
                    <span class="deceased"> - Deceased {{ p.deathYear }}</span>
                  }
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Source -->
          <ng-container matColumnDef="source">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Source</th>
            <td mat-cell *matCellDef="let p">
              <span class="source-badge">{{ p.sourceName }}</span>
            </td>
          </ng-container>

          <!-- Cohorts -->
          <ng-container matColumnDef="cohorts">
            <th mat-header-cell *matHeaderCellDef>Cohorts</th>
            <td mat-cell *matCellDef="let p">
              <div class="cohorts-cell">
                @for (cohort of p.cohorts.slice(0, 2); track cohort) {
                  <mat-chip class="cohort-chip">{{ cohort }}</mat-chip>
                }
                @if (p.cohorts.length > 2) {
                  <span class="more-cohorts">+{{ p.cohorts.length - 2 }}</span>
                }
              </div>
            </td>
          </ng-container>

          <!-- Records -->
          <ng-container matColumnDef="records">
            <th mat-header-cell *matHeaderCellDef>Records</th>
            <td mat-cell *matCellDef="let p">
              <div class="records-cell">
                <div class="total-records">
                  <strong>{{ getTotalRecords(p) }}</strong> total
                </div>
                <div class="record-breakdown">
                  <span matTooltip="Conditions"><i class="fas fa-diagnoses"></i> {{ p.recordCounts.conditions }}</span>
                  <span matTooltip="Drugs"><i class="fas fa-pills"></i> {{ p.recordCounts.drugs }}</span>
                  <span matTooltip="Procedures"><i class="fas fa-procedures"></i> {{ p.recordCounts.procedures }}</span>
                  <span matTooltip="Measurements"><i class="fas fa-flask"></i> {{ p.recordCounts.measurements }}</span>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Observation Period -->
          <ng-container matColumnDef="observationPeriod">
            <th mat-header-cell *matHeaderCellDef>Observation Period</th>
            <td mat-cell *matCellDef="let p">
              <div class="period-cell">
                <div class="period-dates">
                  {{ formatDate(p.observationPeriod.start) }} - {{ formatDate(p.observationPeriod.end) }}
                </div>
                <div class="period-duration">
                  {{ getObservationYears(p) }} years
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Actions -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let p">
              <div class="actions-cell">
                <button mat-icon-button matTooltip="View Profile" (click)="viewProfile(p)">
                  <i class="fas fa-user"></i>
                </button>
                <button mat-icon-button matTooltip="View Timeline" (click)="viewTimeline(p)">
                  <i class="fas fa-stream"></i>
                </button>
                <button mat-icon-button matTooltip="Export" (click)="exportProfile(p)">
                  <i class="fas fa-file-export"></i>
                </button>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>

        <mat-paginator
          [length]="totalResults()"
          [pageSize]="pageSize"
          [pageIndex]="pageIndex"
          [pageSizeOptions]="[10, 25, 50, 100]"
          (page)="onPageChange($event)"
          showFirstLastButtons
        >
        </mat-paginator>
      </mat-card-content>
    </mat-card>
  } @else {
    <div class="empty-state">
      <i class="fas fa-user-slash"></i>
      <h3>No Profiles Found</h3>
      @if (searchFilter || sourceFilter !== 'all' || genderFilter !== 'all') {
        <p>No profiles match your search criteria.</p>
        <button mat-button color="primary" (click)="searchFilter = ''; sourceFilter = 'all'; genderFilter = 'all'; applyFilters()">
          Clear Filters
        </button>
      } @else {
        <p>No patient profiles are currently available.</p>
      }
    </div>
  }
</div>
