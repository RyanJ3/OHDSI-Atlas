<h2 mat-dialog-title>
  <i class="fas fa-chart-line"></i>
  Incidence Rate Results
</h2>

<mat-dialog-content>
  <div class="analysis-info">
    <h3>{{ data.analysis.name }}</h3>
    <p class="description">{{ data.analysis.description }}</p>
    <div class="cohort-info">
      <mat-chip class="target-chip">
        <i class="fas fa-users"></i>
        Target: {{ data.analysis.targetCohort }}
      </mat-chip>
      <mat-chip class="outcome-chip">
        <i class="fas fa-crosshairs"></i>
        Outcome: {{ data.analysis.outcomeCohort }}
      </mat-chip>
    </div>
  </div>

  <mat-divider></mat-divider>

  <!-- Overall Results -->
  <div class="overall-results">
    <h4>Overall Results</h4>
    <div class="results-grid">
      <mat-card class="result-card">
        <div class="result-label">Persons at Risk</div>
        <div class="result-value">{{ overallResult.personsAtRisk | number }}</div>
      </mat-card>

      <mat-card class="result-card">
        <div class="result-label">Person-Years</div>
        <div class="result-value">{{ overallResult.personYears | number:'1.0-0' }}</div>
      </mat-card>

      <mat-card class="result-card">
        <div class="result-label">Outcomes</div>
        <div class="result-value">{{ overallResult.outcomes | number }}</div>
      </mat-card>

      <mat-card class="result-card highlight">
        <div class="result-label">Incidence Rate</div>
        <div class="result-value">{{ overallResult.incidenceRate.toFixed(2) }}</div>
        <div class="result-unit">per 1,000 person-years</div>
        <div class="result-ci">
          95% CI: {{ overallResult.irLower.toFixed(2) }} - {{ overallResult.irUpper.toFixed(2) }}
        </div>
      </mat-card>
    </div>
  </div>

  <mat-divider></mat-divider>

  <!-- Stratified Results -->
  <div class="stratified-results">
    <h4>Results by Strata</h4>
    <table mat-table [dataSource]="strataResults" class="strata-table">
      <ng-container matColumnDef="strataName">
        <th mat-header-cell *matHeaderCellDef>Strata</th>
        <td mat-cell *matCellDef="let row">{{ row.strataName }}</td>
      </ng-container>

      <ng-container matColumnDef="personsAtRisk">
        <th mat-header-cell *matHeaderCellDef>Persons</th>
        <td mat-cell *matCellDef="let row">{{ row.personsAtRisk | number }}</td>
      </ng-container>

      <ng-container matColumnDef="personYears">
        <th mat-header-cell *matHeaderCellDef>Person-Years</th>
        <td mat-cell *matCellDef="let row">{{ row.personYears | number:'1.0-0' }}</td>
      </ng-container>

      <ng-container matColumnDef="outcomes">
        <th mat-header-cell *matHeaderCellDef>Outcomes</th>
        <td mat-cell *matCellDef="let row">{{ row.outcomes | number }}</td>
      </ng-container>

      <ng-container matColumnDef="incidenceRate">
        <th mat-header-cell *matHeaderCellDef>IR (95% CI)</th>
        <td mat-cell *matCellDef="let row">
          <span class="ir-value">{{ row.incidenceRate.toFixed(2) }}</span>
          <span class="ir-ci">({{ row.irLower.toFixed(2) }} - {{ row.irUpper.toFixed(2) }})</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="visual">
        <th mat-header-cell *matHeaderCellDef>Comparison</th>
        <td mat-cell *matCellDef="let row">
          <div class="ir-bar-container">
            <div
              class="ir-bar"
              [style.width.%]="(row.incidenceRate / maxIR) * 100"
              [matTooltip]="'IR: ' + row.incidenceRate.toFixed(2)"
            ></div>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
  </div>

  <!-- Time Trends -->
  <div class="time-trends">
    <h4>Incidence Over Time</h4>
    <div class="trend-chart">
      <div class="chart-bars">
        @for (year of yearlyRates; track year.year) {
          <div class="year-bar">
            <div
              class="bar-fill"
              [style.height.%]="(year.rate / maxYearlyRate) * 100"
              [matTooltip]="year.year + ': ' + year.rate.toFixed(2) + ' per 1,000 PY'"
            ></div>
            <span class="year-label">{{ year.year }}</span>
          </div>
        }
      </div>
    </div>
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="exportResults()">
    <i class="fas fa-download"></i>
    Export
  </button>
  <button mat-raised-button color="primary" mat-dialog-close>
    Close
  </button>
</mat-dialog-actions>
