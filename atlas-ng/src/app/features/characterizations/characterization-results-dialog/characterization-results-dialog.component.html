<h2 mat-dialog-title>
  <i class="fas fa-user-chart"></i>
  Characterization Results
</h2>

<mat-dialog-content>
  <div class="char-info">
    <h3>{{ data.characterization.name }}</h3>
    <p class="description">{{ data.characterization.description }}</p>
    <div class="execution-meta">
      <span class="meta-item">
        <i class="fas fa-database"></i>
        {{ latestExecution?.sourceName || 'Unknown' }}
      </span>
      <span class="meta-item">
        <i class="fas fa-calendar"></i>
        {{ formatDate(latestExecution?.date) }}
      </span>
    </div>
  </div>

  <mat-divider></mat-divider>

  <!-- Summary Stats -->
  <div class="summary-stats">
    <mat-card class="stat-card">
      <div class="stat-value">{{ totalSubjects | number }}</div>
      <div class="stat-label">Total Subjects</div>
    </mat-card>
    <mat-card class="stat-card">
      <div class="stat-value">{{ covariates.length }}</div>
      <div class="stat-label">Covariates Analyzed</div>
    </mat-card>
    <mat-card class="stat-card">
      <div class="stat-value">{{ categories.length }}</div>
      <div class="stat-label">Categories</div>
    </mat-card>
  </div>

  <mat-tab-group>
    <!-- Demographics Tab -->
    <mat-tab label="Demographics">
      <div class="tab-content">
        <table mat-table [dataSource]="getDemographicsCovariates()" class="covariates-table">
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>Covariate</th>
            <td mat-cell *matCellDef="let row">{{ row.name }}</td>
          </ng-container>

          <ng-container matColumnDef="count">
            <th mat-header-cell *matHeaderCellDef>Count</th>
            <td mat-cell *matCellDef="let row">{{ row.targetCount | number }}</td>
          </ng-container>

          <ng-container matColumnDef="percent">
            <th mat-header-cell *matHeaderCellDef>Prevalence</th>
            <td mat-cell *matCellDef="let row">
              <div class="prevalence-cell">
                <span class="percent-value">{{ row.targetPercent.toFixed(1) }}%</span>
                <mat-progress-bar
                  mode="determinate"
                  [value]="row.targetPercent"
                  color="primary"
                ></mat-progress-bar>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['name', 'count', 'percent']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['name', 'count', 'percent']"></tr>
        </table>
      </div>
    </mat-tab>

    <!-- Conditions Tab -->
    <mat-tab label="Conditions">
      <div class="tab-content">
        <table mat-table [dataSource]="getConditionsCovariates()" class="covariates-table">
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>Condition</th>
            <td mat-cell *matCellDef="let row">{{ row.name }}</td>
          </ng-container>

          <ng-container matColumnDef="count">
            <th mat-header-cell *matHeaderCellDef>Count</th>
            <td mat-cell *matCellDef="let row">{{ row.targetCount | number }}</td>
          </ng-container>

          <ng-container matColumnDef="percent">
            <th mat-header-cell *matHeaderCellDef>Prevalence</th>
            <td mat-cell *matCellDef="let row">
              <div class="prevalence-cell">
                <span class="percent-value">{{ row.targetPercent.toFixed(1) }}%</span>
                <mat-progress-bar
                  mode="determinate"
                  [value]="row.targetPercent"
                  color="accent"
                ></mat-progress-bar>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['name', 'count', 'percent']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['name', 'count', 'percent']"></tr>
        </table>
      </div>
    </mat-tab>

    <!-- Drugs Tab -->
    <mat-tab label="Drugs">
      <div class="tab-content">
        <table mat-table [dataSource]="getDrugsCovariates()" class="covariates-table">
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>Drug</th>
            <td mat-cell *matCellDef="let row">{{ row.name }}</td>
          </ng-container>

          <ng-container matColumnDef="count">
            <th mat-header-cell *matHeaderCellDef>Count</th>
            <td mat-cell *matCellDef="let row">{{ row.targetCount | number }}</td>
          </ng-container>

          <ng-container matColumnDef="percent">
            <th mat-header-cell *matHeaderCellDef>Prevalence</th>
            <td mat-cell *matCellDef="let row">
              <div class="prevalence-cell">
                <span class="percent-value">{{ row.targetPercent.toFixed(1) }}%</span>
                <mat-progress-bar
                  mode="determinate"
                  [value]="row.targetPercent"
                  color="warn"
                ></mat-progress-bar>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['name', 'count', 'percent']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['name', 'count', 'percent']"></tr>
        </table>
      </div>
    </mat-tab>
  </mat-tab-group>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button [matMenuTriggerFor]="exportMenu">
    <i class="fas fa-download"></i>
    Export
    <i class="fas fa-caret-down" style="margin-left: 4px;"></i>
  </button>
  <mat-menu #exportMenu="matMenu">
    <button mat-menu-item (click)="exportResults()">
      <i class="fas fa-file-csv"></i>
      Export as CSV
    </button>
    <button mat-menu-item (click)="exportJSON()">
      <i class="fas fa-file-code"></i>
      Export as JSON
    </button>
  </mat-menu>
  <button mat-raised-button color="primary" mat-dialog-close>
    Close
  </button>
</mat-dialog-actions>
