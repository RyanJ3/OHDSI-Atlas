<div class="estimation-container">
  <div class="page-header">
    <div class="page-header__title">
      <i class="fas fa-balance-scale"></i>
      <h1>Population Level Estimation</h1>
    </div>
    <div class="page-header__actions">
      <button mat-raised-button color="primary" (click)="createNew()">
        <i class="fas fa-plus"></i>
        New Estimation
      </button>
    </div>
  </div>

  <!-- Summary Stats -->
  <div class="stats-row">
    <mat-card class="stat-card">
      <div class="stat-icon total">
        <i class="fas fa-balance-scale"></i>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ estimations().length }}</span>
        <span class="stat-label">Total Studies</span>
      </div>
    </mat-card>

    <mat-card class="stat-card">
      <div class="stat-icon completed">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ getCompletedCount() }}</span>
        <span class="stat-label">Completed</span>
      </div>
    </mat-card>

    <mat-card class="stat-card">
      <div class="stat-icon running">
        <i class="fas fa-spinner"></i>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ getRunningCount() }}</span>
        <span class="stat-label">Running</span>
      </div>
    </mat-card>

    <mat-card class="stat-card">
      <div class="stat-icon pending">
        <i class="fas fa-clock"></i>
      </div>
      <div class="stat-content">
        <span class="stat-value">{{ getNotExecutedCount() }}</span>
        <span class="stat-label">Not Executed</span>
      </div>
    </mat-card>
  </div>

  <!-- Filters -->
  <mat-card class="filter-card">
    <mat-card-content>
      <div class="filter-row">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Search estimation studies</mat-label>
          <input
            matInput
            [(ngModel)]="searchFilter"
            (ngModelChange)="applyFilters()"
            placeholder="Search by name, description, type, or tags..."
          />
          <mat-icon matPrefix>search</mat-icon>
          @if (searchFilter) {
            <button mat-icon-button matSuffix (click)="searchFilter = ''; applyFilters()">
              <mat-icon>close</mat-icon>
            </button>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="status-filter">
          <mat-label>Status</mat-label>
          <mat-select [(ngModel)]="statusFilter" (ngModelChange)="applyFilters()">
            @for (option of statusOptions; track option.value) {
              <mat-option [value]="option.value">{{ option.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Results -->
  @if (loading()) {
    <div class="loading-container">
      <mat-spinner diameter="48"></mat-spinner>
      <p>Loading estimation studies...</p>
    </div>
  } @else if (filteredEstimations().length > 0) {
    <mat-card class="results-card">
      <mat-card-content>
        <table
          mat-table
          [dataSource]="getPaginatedEstimations()"
          matSort
          (matSortChange)="onSort($event)"
          class="estimation-table"
        >
          <!-- ID -->
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
            <td mat-cell *matCellDef="let e">
              <span class="estimation-id">{{ e.id }}</span>
            </td>
          </ng-container>

          <!-- Name -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Name</th>
            <td mat-cell *matCellDef="let e">
              <div class="name-cell">
                <span class="estimation-name">{{ e.name }}</span>
                @if (e.description) {
                  <span class="estimation-description">{{ e.description }}</span>
                }
                @if (e.tags && e.tags.length > 0) {
                  <div class="tags">
                    @for (tag of e.tags.slice(0, 3); track tag) {
                      <mat-chip class="tag-chip">{{ tag }}</mat-chip>
                    }
                    @if (e.tags.length > 3) {
                      <span class="more-tags">+{{ e.tags.length - 3 }}</span>
                    }
                  </div>
                }
              </div>
            </td>
          </ng-container>

          <!-- Type -->
          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Type</th>
            <td mat-cell *matCellDef="let e">
              <span class="type-badge">{{ e.type }}</span>
            </td>
          </ng-container>

          <!-- Comparisons -->
          <ng-container matColumnDef="comparisons">
            <th mat-header-cell *matHeaderCellDef>Comparisons</th>
            <td mat-cell *matCellDef="let e">
              <div class="comparisons-cell">
                <div class="comparison-summary" [matTooltip]="getComparisonSummary(e)">
                  <i class="fas fa-users"></i>
                  <span>{{ e.comparisons.length }} comparison{{ e.comparisons.length !== 1 ? 's' : '' }}</span>
                </div>
                <div class="outcomes-count">
                  <i class="fas fa-crosshairs"></i>
                  <span>{{ getOutcomeCount(e) }} outcome{{ getOutcomeCount(e) !== 1 ? 's' : '' }}</span>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Status -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let e">
              <div class="status-cell" [ngClass]="getStatusClass(e)">
                <i [class]="getStatusIcon(e)"></i>
                <span class="status-label">{{ getStatusLabel(e) }}</span>
                @if (e.latestExecution) {
                  <span class="execution-count">({{ e.executions }}x)</span>
                }
              </div>
            </td>
          </ng-container>

          <!-- Modified Date -->
          <ng-container matColumnDef="modifiedDate">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Modified</th>
            <td mat-cell *matCellDef="let e">
              <div class="date-cell">
                <span class="date">{{ formatDate(e.modifiedDate) }}</span>
                <span class="author">by {{ e.modifiedBy }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Actions -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let e">
              <div class="actions-cell">
                <button mat-icon-button matTooltip="Edit" (click)="editEstimation(e)">
                  <i class="fas fa-edit"></i>
                </button>
                <button
                  mat-icon-button
                  matTooltip="Execute"
                  (click)="executeEstimation(e)"
                  [disabled]="e.latestExecution?.status === 'RUNNING'"
                >
                  <i class="fas fa-play"></i>
                </button>
                <button
                  mat-icon-button
                  matTooltip="View Results"
                  (click)="viewResults(e)"
                  [disabled]="!e.latestExecution || e.latestExecution.status !== 'COMPLETED'"
                >
                  <i class="fas fa-chart-bar"></i>
                </button>
                <button mat-icon-button [matMenuTriggerFor]="actionMenu">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
                <mat-menu #actionMenu="matMenu">
                  <button mat-menu-item (click)="copyEstimation(e)">
                    <i class="fas fa-copy fa-fw"></i>
                    <span>Copy</span>
                  </button>
                  <button mat-menu-item (click)="exportEstimation(e)">
                    <i class="fas fa-file-export fa-fw"></i>
                    <span>Export</span>
                  </button>
                  <mat-divider></mat-divider>
                  <button mat-menu-item class="delete-action" (click)="deleteEstimation(e)">
                    <i class="fas fa-trash fa-fw"></i>
                    <span>Delete</span>
                  </button>
                </mat-menu>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>

        <mat-paginator
          [length]="totalResults()"
          [pageSize]="pageSize"
          [pageIndex]="pageIndex"
          [pageSizeOptions]="[10, 25, 50, 100]"
          (page)="onPageChange($event)"
          showFirstLastButtons
        >
        </mat-paginator>
      </mat-card-content>
    </mat-card>
  } @else {
    <div class="empty-state">
      <i class="fas fa-balance-scale"></i>
      <h3>No Estimation Studies Found</h3>
      @if (searchFilter || statusFilter !== 'all') {
        <p>No studies match your search criteria.</p>
        <button mat-button color="primary" (click)="searchFilter = ''; statusFilter = 'all'; applyFilters()">
          Clear Filters
        </button>
      } @else {
        <p>Create your first population level estimation study to compare treatment effects.</p>
        <button mat-raised-button color="primary" (click)="createNew()">
          <i class="fas fa-plus"></i>
          Create Estimation Study
        </button>
      }
    </div>
  }
</div>
