<h2 mat-dialog-title>
  <i class="fas fa-chart-bar"></i>
  Estimation Results
</h2>

<mat-dialog-content>
  <!-- Study Info -->
  <div class="study-info">
    <h3>{{ data.estimation.name }}</h3>
    <p class="description">{{ data.estimation.description }}</p>
    <div class="comparison-info">
      <mat-chip-set>
        <mat-chip class="target-chip">
          <i class="fas fa-users"></i>
          Target: {{ data.estimation.comparisons[0].targetCohort }}
        </mat-chip>
        <mat-chip class="comparator-chip">
          <i class="fas fa-users"></i>
          Comparator: {{ data.estimation.comparisons[0].comparatorCohort }}
        </mat-chip>
      </mat-chip-set>
    </div>
  </div>

  <mat-divider></mat-divider>

  <!-- Execution Info -->
  <div class="execution-info">
    <div class="info-item">
      <span class="label">Data Source:</span>
      <span class="value">{{ result.sourceName }}</span>
    </div>
    <div class="info-item">
      <span class="label">Execution Date:</span>
      <span class="value">{{ result.executionDate }}</span>
    </div>
    <div class="info-item">
      <span class="label">Target Cohort:</span>
      <span class="value">{{ result.targetCohortCount | number }} subjects</span>
    </div>
    <div class="info-item">
      <span class="label">Comparator Cohort:</span>
      <span class="value">{{ result.comparatorCohortCount | number }} subjects</span>
    </div>
  </div>

  <mat-divider></mat-divider>

  <!-- Results Table -->
  <h4>Outcome Results</h4>
  <table mat-table [dataSource]="result.outcomes" class="results-table">
    <ng-container matColumnDef="outcome">
      <th mat-header-cell *matHeaderCellDef>Outcome</th>
      <td mat-cell *matCellDef="let row">
        <strong>{{ row.outcome }}</strong>
      </td>
    </ng-container>

    <ng-container matColumnDef="targetEvents">
      <th mat-header-cell *matHeaderCellDef>Target Events</th>
      <td mat-cell *matCellDef="let row">
        {{ row.targetOutcomes }} / {{ row.targetSubjects | number }}
        <span class="rate">({{ (row.targetOutcomes / row.targetSubjects * 100).toFixed(2) }}%)</span>
      </td>
    </ng-container>

    <ng-container matColumnDef="comparatorEvents">
      <th mat-header-cell *matHeaderCellDef>Comparator Events</th>
      <td mat-cell *matCellDef="let row">
        {{ row.comparatorOutcomes }} / {{ row.comparatorSubjects | number }}
        <span class="rate">({{ (row.comparatorOutcomes / row.comparatorSubjects * 100).toFixed(2) }}%)</span>
      </td>
    </ng-container>

    <ng-container matColumnDef="hazardRatio">
      <th mat-header-cell *matHeaderCellDef>Hazard Ratio (95% CI)</th>
      <td mat-cell *matCellDef="let row">
        <span class="hr-value" [ngClass]="getHRClass(row.hazardRatio, row.ciLower, row.ciUpper)">
          {{ row.hazardRatio.toFixed(2) }}
        </span>
        <span class="ci">({{ row.ciLower.toFixed(2) }} - {{ row.ciUpper.toFixed(2) }})</span>
      </td>
    </ng-container>

    <ng-container matColumnDef="pValue">
      <th mat-header-cell *matHeaderCellDef>P-value</th>
      <td mat-cell *matCellDef="let row">
        <span [ngClass]="{'significant': row.pValue < 0.05}">
          {{ row.pValue < 0.001 ? '< 0.001' : row.pValue.toFixed(3) }}
        </span>
      </td>
    </ng-container>

    <ng-container matColumnDef="forest">
      <th mat-header-cell *matHeaderCellDef>Forest Plot</th>
      <td mat-cell *matCellDef="let row">
        <div class="mini-forest">
          <div class="forest-line"></div>
          <div class="forest-ref"></div>
          <div
            class="forest-point"
            [style.left.%]="getForestPosition(row.hazardRatio)"
            [matTooltip]="'HR: ' + row.hazardRatio.toFixed(2)"
          ></div>
          <div
            class="forest-ci"
            [style.left.%]="getForestPosition(row.ciLower)"
            [style.width.%]="getForestPosition(row.ciUpper) - getForestPosition(row.ciLower)"
          ></div>
        </div>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
  </table>

  <!-- Legend -->
  <div class="legend">
    <span class="legend-item">
      <span class="dot protective"></span> HR &lt; 1 (favors target)
    </span>
    <span class="legend-item">
      <span class="dot neutral"></span> HR â‰ˆ 1 (no difference)
    </span>
    <span class="legend-item">
      <span class="dot harmful"></span> HR &gt; 1 (favors comparator)
    </span>
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button [matMenuTriggerFor]="exportMenu">
    <i class="fas fa-download"></i>
    Export
    <i class="fas fa-caret-down" style="margin-left: 4px;"></i>
  </button>
  <mat-menu #exportMenu="matMenu">
    <button mat-menu-item (click)="exportResults()">
      <i class="fas fa-file-csv"></i>
      Export as CSV
    </button>
    <button mat-menu-item (click)="exportJSON()">
      <i class="fas fa-file-code"></i>
      Export as JSON
    </button>
  </mat-menu>
  <button mat-raised-button color="primary" mat-dialog-close>
    Close
  </button>
</mat-dialog-actions>
